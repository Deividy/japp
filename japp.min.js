var allowedOptions=["errorHandler","routes"],defaultErrorHandler=function(a,b){alert(b),window.location.reload(!0)},JApp=function(a){this._currentPage=null,this._currentDisplay=null,this._pages=[],this._pageById={},this.routes={},_.extend(this,_.pick(a,allowedOptions)),_.extend(this,Backbone.Events),this.constructor.apply(this,arguments)};_.extend(JApp.prototype,{errorHandler:defaultErrorHandler,constructor:function(){},createRoutesForPages:function(){_.each(this._pages,function(a){a.isRoute&&!this.routes[a.id]&&(this.routes[a.id]=_.bind(function(){this.navigate(a.id)},this))},this)},startRouter:function(){this.createRoutesForPages();var a=Backbone.Router.extend({routes:this.routes});this.router=new a,Backbone.history.start()},addPage:function(a){F.demandGoodObject(a,"pageObj");var b=new JA.Page(a);return this._pages.push(b),this._pageById[b.id]=b,b},page:function(a){F.demandGoodString(a,"pageId");var b=this._pageById[a];if(b)return b;throw new Error("Page "+a+" not found!")},currentPage:function(){return this._currentPage},currentDisplay:function(){return this._currentDisplay},currentDisplay:function(){return this._currentDisplay},navigate:function(a){F.demandGoodString(a,"pageId"),this._currentPage=null,_.each(this._pages,function(b){return b.id!==a?b.deactivate():(b.activate(),void(this._currentPage=b))},this)},get:function(a,b,c){_.isFunction(b)&&(c=b,b={}),F.demandGoodString(a,"url"),F.demandObject(b,"data"),F.demandFunction(c,"callback"),$.get(a,b).done(c).fail(this.errorHandler)},post:function(a,b,c){_.isFunction(b)&&(c=b,b={}),F.demandGoodString(a,"url"),F.demandObject(b,"data"),F.demandFunction(c,"callback"),$.post(a,b).done(c).fail(this.errorHandler)}}),JA={build:function(a){a||(a={});var b=new JApp(a);_.extend(this,b)},inherit:function(a,b){function c(){this.constructor=a.constructor}c.prototype=b.prototype;for(var d in b)Object.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a.prototype=new c,a},extendAndApplyDefaults:function(a,b,c){_.extend(a,_.defaults(b,c))}};var displayTemplate={afterDeactivate:function(){},beforeDeactivate:function(a){a()},afterActivate:function(){},beforeActivate:function(a){a()},render:function(){return this.$container.html(this._template()),this}};JA.Display=function(a){F.demandGoodObject(a,"options"),F.demandGoodString(a.id,"options.id"),F.demandGoodString(a.container,"options.container"),JA.extendAndApplyDefaults(this,a,displayTemplate),this.selector||(this.selector=this.container),this.$container=$(this.container),this.render(),this.delegateEvents(this.events)},JA.inherit(JA.Display,Backbone.View),_.extend(JA.Display.prototype,{$:function(){return $(this.selector)},activate:function(){var a=this;this.beforeActivate(function(){a.show(),a.afterActivate()})},deactivate:function(){var a=this;this.beforeDeactivate(function(){a.hide(),a.afterDeactivate()})},hide:function(){this.$().hide()},show:function(){this.$().show()},_template:function(){return _.isFunction(this.template)?this.template.apply(this,arguments):_.template($(this.template).html())}});var pageTemplate={_displays:[],_displayById:{},isRoute:!0,afterDeactivate:function(){},beforeDeactivate:function(a){a()},afterActivate:function(){},beforeActivate:function(){throw new Error("Must implement and pass a display id to next()")}};JA.Page=function(a){F.demandGoodObject(a,"options"),F.demandGoodString(a.id,"options.id"),this._currentDisplay=null,JA.extendAndApplyDefaults(this,a,pageTemplate),_.extend(this,Backbone.Events)},_.extend(JA.Page.prototype,{display:function(a){F.demandGoodString(a,"displayId");var b=this._displayById[a];if(b)return b;throw new Error("Display "+a+" not found!")},addDisplay:function(a){F.demandGoodObject(a,"obj");var b=new JA.Display(a);return this._displays.push(b),this._displayById[b.id]=b,b.hide(),b},navigate:function(a){F.demandGoodString(a,"displayId"),this._currentDisplay=null,JA._currentDisplay=null,_.each(this._displays,function(b){return b.id!==a?b.deactivate():(b.activate(),this._currentDisplay=b,void(JA._currentDisplay=b))},this)},activate:function(){var a=this;this.beforeActivate(function(b){F.demandGoodString(b,"displayId"),a.navigate(b),a.afterActivate()})},deactivate:function(){var a=this;this.beforeDeactivate(function(){a._activeDisplay.deactivate(),a.afterDeactivate()})}});